SELECT DISTINCT П.idПользователя, ОбщаяСуммаВсехКонвертаций.ОбщаяСуммаВсехКонвертаций * 1 
	+ КоличествоДнейСДатыПоследнейКонвертации.КоличествоДнейСДатыПоследнейКонвертации * (-0.5)
	+ ЧастотаКонвертаций.ЧастотаКонвертаций * 1 + КоличествоДнейСМоментаРегистрации.КоличествоДнейСМоментаРегистрации * 1 
	+ ДлинаНазванияФормата.НаиболееЧастоИспользуемыйФормат * 0 AS АддитивныйКритерий
FROM 
Пользователи AS П
LEFT JOIN
(
	SELECT DISTINCT П.idПользователя, EXTRACT(DAY, AGE(П.ДатаРегистрации)) * 1.0 / 
	(SELECT MAX(EXTRACT(DAY, AGE(П.ДатаРегистрации))) 
	FROM Пользователи) AS КоличествоДнейСМоментаРегистрации
	FROM Пользователи AS П
	GROUP BY П.idПользователя, П.ДатаРегистрации
) AS КоличествоДнейСМоментаРегистрации ON П.idПользователя = КоличествоДнейСМоментаРегистрации.idПользователя
LEFT JOIN
(
	SELECT DISTINCT П.idПользователя, COALESCE(EXTRACT(DAY, AGE(MAX(К.ДатаКонвертации))), 0) * 1.0 / 
	(SELECT MAX(Д.КрайняяДата)
		FROM (
		SELECT П.idПользователя, COALESCE(EXTRACT(DAY, AGE(MAX(К.ДатаКонвертации))), 0) AS КрайняяДата
		FROM Конвертации AS К, Пользователи AS П, ИсторияКонвертаций AS И
		WHERE П.idПользователя = И.idПользователя AND И.idКонвертации = К.idКонвертации
		GROUP BY П.idПользователя
	) AS Д) AS КоличествоДнейСДатыПоследнейКонвертации
	FROM Пользователи AS П 
	LEFT JOIN ИсторияКонвертаций AS И ON П.idПользователя = И.idПользователя
	LEFT JOIN Конвертации AS К ON И.IDКонвертации = К.IDКонвертации
	GROUP BY П.idПользователя
) AS КоличествоДнейСДатыПоследнейКонвертации ON КоличествоДнейСМоментаРегистрации.idПользователя = КоличествоДнейСДатыПоследнейКонвертации.idПользователя
LEFT JOIN 
(
	SELECT
	ДатыВсехКонвертаций.idПользователя, 
	COALESCE(AVG(CAST(EXTRACT(DAY, ДатыВсехКонвертаций.ДатаКонвертации, ПорядковыйНомерМинус1.ДатаКонвертации) AS DEC(7, 4))), 0) /  
	(SELECT MAX(С.СредКонв) FROM (SELECT COALESCE(AVG(CAST(EXTRACT(DAY, ДатыВсехКонвертаций.ДатаКонвертации, ПорядковыйНомерМинус1.ДатаКонвертации) AS DEC(7, 4))), 0) AS СредКонв
	FROM
	(SELECT TOP (100) И.idПользователя, К.ДатаКонвертации, ROW_NUMBER() OVER (ORDER BY И.idПользователя, К.ДатаКонвертации) AS ПорядковыйНомер
		FROM ИсторияКонвертаций AS И INNER JOIN Конвертации AS К ON И.IDКонвертации = К.IDКонвертации 
		ORDER BY И.idПользователя, К.ДатаКонвертации
	) AS ДатыВсехКонвертаций
	LEFT OUTER JOIN (SELECT idПользователя, ДатаКонвертации, ПорядковыйНомер - 1 AS ПорядковыйНомерМинус1 
		FROM (SELECT TOP (100) И.idПользователя, К.ДатаКонвертации, ROW_NUMBER() OVER (ORDER BY И.idПользователя, К.ДатаКонвертации) AS ПорядковыйНомер
			FROM dbo.ИсторияКонвертаций AS И INNER JOIN dbo.Конвертации AS К ON И.idКонвертации = К.idКонвертации 
			ORDER BY И.idПользователя, К.ДатаКонвертации) AS ДатыВсехКонвертаций
	) AS ПорядковыйНомерМинус1 
	ON ДатыВсехКонвертаций.idПользователя = ПорядковыйНомерМинус1.idПользователя 
		AND ДатыВсехКонвертаций.ПорядковыйНомер = ПорядковыйНомерМинус1.ПорядковыйНомерМинус1
	GROUP BY ДатыВсехКонвертаций.idПользователя
	) С) AS ЧастотаКонвертаций 
	FROM
		(SELECT TOP (100) И.idПользователя, К.ДатаКонвертации, ROW_NUMBER() OVER (ORDER BY И.idПользователя, К.ДатаКонвертации) AS ПорядковыйНомер
			FROM ИсторияКонвертаций AS И INNER JOIN Конвертации AS К ON И.idКонвертации = К.idКонвертации 
			ORDER BY И.idПользователя, К.ДатаКонвертации
		) AS ДатыВсехКонвертаций
		LEFT OUTER JOIN (SELECT idПользователя, ДатаКонвертации, ПорядковыйНомер - 1 AS ПорядковыйНомерМинус1 
			FROM (SELECT TOP (100) И.idПользователя, К.ДатаКонвертации, ROW_NUMBER() OVER (ORDER BY И.idПользователя, К.ДатаКонвертации) AS ПорядковыйНомер
				FROM dbo.ИсторияКонвертаций AS И INNER JOIN dbo.Конвертации AS К ON И.idКонвертации = К.idКонвертации 
				ORDER BY И.idПользователя, К.ДатаКонвертации) AS ДатыВсехКонвертаций
		) AS ПорядковыйНомерМинус1 
		ON ДатыВсехКонвертаций.idПользователя = ПорядковыйНомерМинус1.idПользователя 
			AND ДатыВсехКонвертаций.ПорядковыйНомер = ПорядковыйНомерМинус1.ПорядковыйНомерМинус1
	GROUP BY ДатыВсехКонвертаций.idПользователя
) AS ЧастотаКонвертаций ON КоличествоДнейСДатыПоследнейКонвертации.idПользователя = ЧастотаКонвертаций.idПользователя
LEFT JOIN 
(
	SELECT DISTINCT П.idПользователя, COALESCE(LENGTH(Ф.Название),0) * 1.0 /
	(SELECT MAX(ДлинаНазванияФормата) 
		FROM(
			SELECT П.idПользователя, LENGTH(Ф.Название) AS ДлинаНазванияФормата
			FROM Пользователи AS П, ИспользованиеФорматов AS И, ФорматыФайлов AS Ф
			WHERE П.idПользователя = И.idПользователя AND И.IDФормата = Ф.IDФормата 
			GROUP BY П.idПользователя, КоличествоИспользований, Ф.Название
			HAVING И.КоличествоИспользований = (SELECT MAX(И.КоличествоИспользований) FROM ИспользованиеФорматов AS И WHERE И.idПользователя = П.idПользователя)
		)Д
	) AS НаиболееЧастоИспользуемыйФормат
	FROM Пользователи AS П
	LEFT JOIN ИспользованиеФорматов AS И ON П.idПользователя = И.idПользователя
	LEFT JOIN ФорматыФайлов AS Ф ON И.IDФормата = Ф.IDФормата 
	GROUP BY П.idПользователя, Ф.Название
) AS ДлинаНазванияФормата ON ЧастотаКонвертаций.idПользователя = ДлинаНазванияФормата.idПользователя
LEFT JOIN 
(
	SELECT П.idПользователя, COUNT(И.idИсторииКонвертаций) * 1.0 /
	(SELECT MAX(ОбщаяСуммаВсехКонвертаций) 
		FROM (
		SELECT П.idПользователя, COUNT(И.IDИсторииКонвертаций) AS ОбщаяСуммаВсехКонвертаций
		FROM Пользователи AS П LEFT JOIN ИсторияКонвертаций AS И 
		ON И.idПользователя = П.idПользователя
		GROUP BY П.idПользователя
		) О
	) AS ОбщаяСуммаВсехКонвертаций 
	FROM Пользователи AS П LEFT JOIN ИсторияКонвертаций AS И 
	ON И.idПользователя = П.idПользователя
	GROUP BY П.idПользователя
) AS ОбщаяСуммаВсехКонвертаций ON ДлинаНазванияФормата.idПользователя = ОбщаяСуммаВсехКонвертаций.idПользователя
ORDER BY П.idПользователя;